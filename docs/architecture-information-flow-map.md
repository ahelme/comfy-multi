# ComfyUI Multi-User Platform - Complete Information Flow Map

**Doc Created:** 2026-01-31
**Purpose:** Comprehensive visual map of all information flows between components
**Status:** Current Architecture (v0.9.2)

---

## ğŸ—ºï¸ Complete System Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            EXTERNAL WORLD                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ User Browser â”‚          â”‚ User Browser â”‚          â”‚ Admin Browserâ”‚      â”‚
â”‚  â”‚  (user001)   â”‚          â”‚  (user020)   â”‚          â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚ HTTPS                   â”‚ HTTPS                   â”‚ HTTPS         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                         â”‚                         â”‚
          â”‚                         â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               NGINX (mello VPS)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ SSL Termination (cert.pem, key.pem)                         â”‚            â”‚
â”‚  â”‚ HTTP Basic Auth (/etc/nginx/comfyui-users.htpasswd)         â”‚            â”‚
â”‚  â”‚ Routes:                                                      â”‚            â”‚
â”‚  â”‚  - /user001-020/  â†’ frontend containers (8188-8207)         â”‚            â”‚
â”‚  â”‚  - /api/          â†’ queue-manager (3000)                    â”‚            â”‚
â”‚  â”‚  - /admin/        â†’ admin dashboard (8080)                  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                        â”‚                        â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  Frontend      â”‚      â”‚ Queue Manager  â”‚      â”‚ Admin Dashboard â”‚
       â”‚  Containers    â”‚      â”‚  (FastAPI)     â”‚      â”‚   (FastAPI)     â”‚
       â”‚  x20           â”‚      â”‚  Port 3000     â”‚      â”‚   Port 8080     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                        â”‚                        â”‚
               â”‚                        â”‚                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      COMFYUI LAYER (mello VPS)                               â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              20 FRONTEND CONTAINERS (CPU-only ComfyUI v0.9.2)        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚   user001       â”‚   â”‚   user002       â”‚   ...   â”‚   user020    â”‚ â”‚    â”‚
â”‚  â”‚  â”‚   :8188         â”‚   â”‚   :8189         â”‚         â”‚   :8207      â”‚ â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚    â”‚
â”‚  â”‚  â”‚ ComfyUI v0.9.2  â”‚   â”‚ ComfyUI v0.9.2  â”‚         â”‚ ComfyUI v0.9.â”‚ â”‚    â”‚
â”‚  â”‚  â”‚ main.py --cpu   â”‚   â”‚ main.py --cpu   â”‚         â”‚ main.py --cpuâ”‚ â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚    â”‚
â”‚  â”‚  â”‚ Custom Nodes:   â”‚   â”‚ Custom Nodes:   â”‚         â”‚ Custom Nodes:â”‚ â”‚    â”‚
â”‚  â”‚  â”‚ - default_      â”‚   â”‚ - default_      â”‚         â”‚ - default_   â”‚ â”‚    â”‚
â”‚  â”‚  â”‚   workflow_     â”‚   â”‚   workflow_     â”‚         â”‚   workflow_  â”‚ â”‚    â”‚
â”‚  â”‚  â”‚   loader        â”‚   â”‚   loader        â”‚         â”‚   loader     â”‚ â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚    â”‚
â”‚  â”‚  â”‚ API Endpoints:  â”‚   â”‚ API Endpoints:  â”‚         â”‚ API Endpointsâ”‚ â”‚    â”‚
â”‚  â”‚  â”‚ - /api/userdata â”‚   â”‚ - /api/userdata â”‚         â”‚ - /api/      â”‚ â”‚    â”‚
â”‚  â”‚  â”‚ - /api/default_ â”‚   â”‚ - /api/default_ â”‚         â”‚ - /api/      â”‚ â”‚    â”‚
â”‚  â”‚  â”‚   workflow      â”‚   â”‚   workflow      â”‚         â”‚   default_   â”‚ â”‚    â”‚
â”‚  â”‚  â”‚ - /api/prompt   â”‚   â”‚ - /api/prompt   â”‚         â”‚   workflow   â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚        â”‚                     â”‚                            â”‚           â”‚    â”‚
â”‚  â”‚        â”‚ Volume Mounts       â”‚                            â”‚           â”‚    â”‚
â”‚  â”‚        â–¼                     â–¼                            â–¼           â”‚    â”‚
â”‚  â”‚  /comfyui/user/default/workflows/                                     â”‚    â”‚
â”‚  â”‚  /comfyui/custom_nodes/                                               â”‚    â”‚
â”‚  â”‚  /comfyui/models/ â†’ symlink to /models/shared/                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                               â”‚
â”‚  When user clicks "Queue Prompt" in frontend:                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. Frontend: POST /api/prompt â†’ custom_node/queue_redirect.js      â”‚     â”‚
â”‚  â”‚ 2. Queue Redirect: POST â†’ Queue Manager /api/jobs                  â”‚     â”‚
â”‚  â”‚ 3. Job data: { user_id, workflow_json, priority, metadata }        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      QUEUE LAYER (mello VPS)                                 â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                       QUEUE MANAGER (FastAPI)                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ Endpoints:                                                       â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  POST   /api/jobs              â†’ Submit job to queue            â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  GET    /api/jobs              â†’ List all jobs                  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  GET    /api/jobs/{id}         â†’ Get job details                â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  DELETE /api/jobs/{id}         â†’ Cancel job                     â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  PATCH  /api/jobs/{id}/priority â†’ Update priority               â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  GET    /api/queue/status      â†’ Queue statistics               â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  GET    /api/workers/next-job  â†’ Worker polls for job           â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  POST   /api/workers/complete  â†’ Worker marks job done          â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  POST   /api/workers/fail      â†’ Worker marks job failed        â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  WS     /ws                    â†’ WebSocket for live updates     â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚         â”‚                                                              â”‚   â”‚
â”‚  â”‚         â”‚ Reads/Writes                                                â”‚   â”‚
â”‚  â”‚         â–¼                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚                    REDIS (Tailscale VPN)                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  100.99.216.71:6379 (password protected)                        â”‚ â”‚   â”‚
â”‚  â”‚  â”‚                                                                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  Data Structures:                                                â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - jobs:pending    (List: job IDs in FIFO order)                â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - jobs:running    (Hash: job_id â†’ worker_id)                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - jobs:completed  (Sorted Set: by timestamp)                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - jobs:failed     (Sorted Set: by timestamp)                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - job:{id}        (Hash: job data)                             â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - job:{id}:status (String: pending/running/completed/failed)   â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ADMIN DASHBOARD (FastAPI)                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ Frontend (HTML/JS in response):                                  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Fetches: GET /api/queue/status                               â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Fetches: GET /api/jobs                                       â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - WebSocket: /ws for live updates                              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Actions: DELETE /api/jobs/{id}                               â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Actions: PATCH /api/jobs/{id}/priority                       â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚         â”‚                                                              â”‚   â”‚
â”‚  â”‚         â”‚ Proxies to Queue Manager                                    â”‚   â”‚
â”‚  â”‚         â–¼                                                              â”‚   â”‚
â”‚  â”‚  (All API calls go through Queue Manager)                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚ Tailscale VPN (100.99.216.71 â†” 100.89.38.43)
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WORKER LAYER (Verda GPU Cloud)                          â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  GPU WORKER CONTAINERS (1-3 workers)                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚                   worker-1 (H100 GPU)                            â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ worker.py (polling loop):                                   â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  1. GET queue-manager /api/workers/next-job                â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  2. Receives: { job_id, workflow_json, user_id }           â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  3. POST ComfyUI /prompt (workflow)                        â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  4. Wait for ComfyUI to complete (polling /history)        â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  5. POST queue-manager /api/workers/complete-job           â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚         â”‚                                                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚         â”‚ Calls ComfyUI API                                      â”‚ â”‚   â”‚
â”‚  â”‚  â”‚         â–¼                                                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚            ComfyUI v0.9.2 (GPU mode)                        â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  localhost:8188                                             â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                                              â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  API Endpoints:                                             â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  - POST /prompt         â†’ Queue workflow execution         â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  - GET  /history/{id}   â†’ Get execution status/results     â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  - GET  /system_stats   â†’ Health check                     â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚                â”‚                                                  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚                â”‚ Reads/Writes                                    â”‚ â”‚   â”‚
â”‚  â”‚  â”‚                â–¼                                                  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Models: /models/shared â†’ /mnt/sfs/models (SFS mount)       â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Outputs: /outputs â†’ /mnt/scratch/outputs (block storage)   â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Inputs: /inputs â†’ /mnt/scratch/inputs (block storage)      â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STORAGE LAYER                                        â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Verda SFS (Network File System)                          â”‚   â”‚
â”‚  â”‚  /mnt/sfs/models/                                                     â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ checkpoints/                                                   â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ ltx-2-19b-dev-fp8.safetensors                              â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ flux2_klein_9b.safetensors                                 â”‚   â”‚
â”‚  â”‚    â”‚   â””â”€â”€ flux2_klein_4b.safetensors                                 â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ text_encoders/                                                 â”‚   â”‚
â”‚  â”‚    â”‚   â””â”€â”€ gemma_3_12B_it.safetensors                                 â”‚   â”‚
â”‚  â”‚    â””â”€â”€ latent_upscale_models/                                         â”‚   â”‚
â”‚  â”‚        â””â”€â”€ ltx-2-spatial-upscaler-x2-1.0.safetensors                  â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  /mnt/sfs/cache/                                                       â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ worker-image.tar.gz                                            â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ verda-config-backup.tar.gz                                     â”‚   â”‚
â”‚  â”‚    â””â”€â”€ scripts/                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Verda Block Storage (Ephemeral Scratch)                     â”‚   â”‚
â”‚  â”‚  /mnt/scratch/outputs/                                                â”‚   â”‚
â”‚  â”‚  /mnt/scratch/inputs/                                                 â”‚   â”‚
â”‚  â”‚  /mnt/scratch/temp/                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 Cloudflare R2 (Permanent Backup)                      â”‚   â”‚
â”‚  â”‚  comfy-multi-model-vault-backup/    (Models)                          â”‚   â”‚
â”‚  â”‚  comfy-multi-cache/                 (Container + Config)              â”‚   â”‚
â”‚  â”‚  comfy-multi-user-files/            (User workflows + outputs)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Mello VPS (Local Data)                             â”‚   â”‚
â”‚  â”‚  /home/dev/comfy-multi/data/                                          â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ workflows/              (Template workflows - read-only)       â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ flux2_klein_9b_text_to_image.json                          â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ flux2_klein_4b_text_to_image.json                          â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ ltx2_text_to_video.json                                    â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ ltx2_text_to_video_distilled.json                          â”‚   â”‚
â”‚  â”‚    â”‚   â””â”€â”€ example_workflow.json                                      â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ user_data/                                                     â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ user001/                                                   â”‚   â”‚
â”‚  â”‚    â”‚   â”‚   â”œâ”€â”€ comfyui.db                                             â”‚   â”‚
â”‚  â”‚    â”‚   â”‚   â”œâ”€â”€ default/workflows/  (copied from templates)            â”‚   â”‚
â”‚  â”‚    â”‚   â”‚   â””â”€â”€ comfyui/custom_nodes/                                  â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ user002/                                                   â”‚   â”‚
â”‚  â”‚    â”‚   â””â”€â”€ ... (user003-020)                                          â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ models -> symlink to /mnt/sfs/models (for setup script)        â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ outputs -> symlink to /mnt/scratch/outputs                     â”‚   â”‚
â”‚  â”‚    â””â”€â”€ inputs -> symlink to /mnt/scratch/inputs                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š API Call Sequences

### User Submits Job (End-to-End Flow)

```
User Browser
    â”‚
    â”‚ Click "Queue Prompt"
    â–¼
Frontend Container (user001:8188)
    â”‚
    â”‚ JavaScript: POST /api/prompt
    â–¼
Custom Node: queue_redirect.js
    â”‚
    â”‚ Intercepts call, extracts workflow
    â”‚ POST queue-manager:3000/api/jobs
    â”‚ { user_id: "user001",
    â”‚   workflow: { ...workflow_json... },
    â”‚   priority: 1,
    â”‚   metadata: {...} }
    â–¼
Queue Manager (FastAPI)
    â”‚
    â”‚ Validates job
    â”‚ Generates job_id (UUID)
    â”‚ Stores in Redis: jobs:pending, job:{id}
    â”‚ Publishes WebSocket event
    â”‚ Returns: { job_id, position_in_queue }
    â–¼
Redis (jobs:pending list)
    â”‚
    â”‚ [job_id_1, job_id_2, job_id_3]
    â”‚
    â”‚ Worker polls every 2 seconds...
    â–¼
Worker (Verda GPU)
    â”‚
    â”‚ GET queue-manager:3000/api/workers/next-job
    â”‚ ?worker_id=worker-1
    â–¼
Queue Manager
    â”‚
    â”‚ LPOP jobs:pending â†’ job_id
    â”‚ HSET jobs:running job_id worker-1
    â”‚ Returns: { job_id, workflow, user_id }
    â–¼
Worker
    â”‚
    â”‚ POST localhost:8188/prompt
    â”‚ { "prompt": workflow_json }
    â–¼
ComfyUI (GPU mode)
    â”‚
    â”‚ Executes workflow on GPU
    â”‚ Saves outputs to /outputs/
    â”‚ Stores in history
    â–¼
Worker (polls for completion)
    â”‚
    â”‚ GET localhost:8188/history/{prompt_id}
    â”‚ (every 2s until status.completed = true)
    â”‚
    â”‚ POST queue-manager:3000/api/workers/complete-job
    â”‚ { outputs, execution_time }
    â–¼
Queue Manager
    â”‚
    â”‚ HDEL jobs:running job_id
    â”‚ ZADD jobs:completed timestamp job_id
    â”‚ HSET job:{id} status=completed
    â”‚ Publishes WebSocket event
    â–¼
Admin Dashboard (WebSocket client)
    â”‚
    â”‚ Receives job_updated event
    â”‚ Refreshes job list
    â”‚ Updates statistics
```

### User Loads Workflow (Frontend)

```
User Browser
    â”‚
    â”‚ Navigate to /user001/
    â–¼
Nginx
    â”‚
    â”‚ HTTP Basic Auth (user001:password)
    â”‚ Proxy to frontend container :8188
    â–¼
Frontend Container (user001)
    â”‚
    â”‚ ComfyUI loads frontend bundle.js
    â”‚ JavaScript: GET /api/userdata?dir=workflows
    â–¼
ComfyUI v0.9.2 Userdata API
    â”‚
    â”‚ Reads: /comfyui/user/default/workflows/
    â”‚ Returns: ["flux2_klein_9b_text_to_image.json", ...]
    â–¼
Frontend JS
    â”‚
    â”‚ User clicks workflow in menu
    â”‚ GET /api/userdata/workflows%2Fflux2_klein_9b_text_to_image.json
    â”‚        â†‘
    â”‚        â””â”€ URL ENCODED PATH! (v0.9.2 requirement)
    â–¼
ComfyUI Userdata API
    â”‚
    â”‚ Decodes path: workflows/flux2_klein_9b_text_to_image.json
    â”‚ Reads: /comfyui/user/default/workflows/flux2_klein_9b_text_to_image.json
    â”‚ Returns: workflow JSON
    â–¼
Frontend JS
    â”‚
    â”‚ app.loadGraphData(workflow_json)
    â”‚ Workflow displayed in UI
```

---

## ğŸ”§ Version-Specific ComfyUI Behaviors

### v0.9.2 (Current)

**Workflow Storage:**
- Location: `/comfyui/user/default/workflows/`
- List API: `GET /api/userdata?dir=workflows`
- Load API: `GET /api/userdata/workflows%2F{filename}` (URL ENCODED!)
- Save API: `POST /api/userdata/workflows%2F{filename}`

**Execution API:**
- Submit: `POST /prompt { "prompt": workflow_json }`
- Status: `GET /history/{prompt_id}`
- Outputs in history response

**Custom Nodes:**
- Location: `/comfyui/custom_nodes/`
- Register endpoints: `server.PromptServer.instance.routes.get()`

### v0.11.1 (Target - NEEDS RESEARCH!)

**UNKNOWN - Questions to Answer:**
- Where are workflows stored?
- API endpoint changes for userdata?
- URL encoding still required?
- Prompt submission format changes?
- History API changes?
- Custom node registration changes?
- New authentication mechanisms?
- Breaking changes in workflow JSON format?

---

## ğŸ¯ Critical Touchpoints (Where Versions Matter)

### 1. Worker â†’ ComfyUI API Calls
**Current:** `worker.py` line 84-96
```python
self.client.post(f"{self.base_url}/prompt", json={"prompt": workflow})
self.client.get(f"{self.base_url}/history/{prompt_id}")
```
**Risk:** v0.11.1 may change API format

### 2. Frontend â†’ Userdata API
**Current:** `docker-entrypoint.sh` creates workflows at:
```bash
/comfyui/user/default/workflows/*.json
```
**Risk:** v0.11.1 may change path structure

### 3. Custom Node Registration
**Current:** `default_workflow_loader/__init__.py` line 71-74
```python
import server
@server.PromptServer.instance.routes.get("/api/default_workflow")
```
**Risk:** v0.11.1 may change server module structure

---

## âš ï¸ WHERE TRANSLATION LAYER IS NEEDED

Based on this map, the translation layer should handle:

1. **Worker â†” ComfyUI API** (CRITICAL)
   - Prompt submission format
   - History polling
   - Output retrieval

2. **Frontend Userdata Paths** (HIGH)
   - Workflow storage locations
   - URL encoding requirements
   - File path conventions

3. **Custom Node Server Access** (MEDIUM)
   - Server module imports
   - Route registration
   - API endpoint patterns

4. **Queue Manager** (LOW - Already decoupled via Redis!)
   - No direct ComfyUI dependency
   - Just passes workflow JSON through

---

**Next Step:** Research ComfyUI v0.11.1 changes to identify EXACT differences!
